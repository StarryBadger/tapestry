syntax = "proto3";

option go_package = "tapestry/api/proto";

message Nothing {}

// --- Core Data Structures ---

message NodeID {
    bytes bytes = 1;
}

message Neighbor {
    NodeID id = 1;
    string address = 2; // "IP:Port"
}

message RoutingTableEntry {
    repeated Neighbor neighbors = 1;
}

// --- Dynamic Node Management ---

message RTCopyResponse {
    repeated RoutingTableEntry entries = 1; 
    int32 rows = 2; 
    int32 cols = 3; 
}

message MulticastRequest {
    Neighbor new_node = 1;
    int32 level = 2; 
}

message BackpointerRequest {
    Neighbor from = 1;
    int32 level = 2; 
}

// --- Routing & Object Location (DOLR) ---

message RouteRequest {
    NodeID target_id = 1;
    NodeID source_id = 2; 
}

message RouteResponse {
    Neighbor next_hop = 1; 
    bool is_root = 2;      
}

message PublishRequest {
    NodeID object_id = 1;
    Neighbor publisher = 2; 
    int32 hop_limit = 3; // Required to prevent infinite loops
}

message LookupRequest {
    NodeID object_id = 1;
    int32 hop_limit = 2; // Required to prevent infinite loops
}

message LookupResponse {
    repeated Neighbor publishers = 1;
    bool found = 2;         
}

message ReplicateRequest {
    string key = 1;
    string data = 2;
}

message Ack {
    bool success = 1;
}


// --- Data Retrieval ---

message FetchRequest {
    string key = 1;
}

message FetchResponse {
    string data = 1;
    bool found = 2;
}

// --- Service Definition ---

service NodeService {
    rpc Ping(Nothing) returns (Nothing);
    
    // Core Routing
    rpc GetNextHop(RouteRequest) returns (RouteResponse);
    
    // Bootstrap & Maintenance
    rpc GetRoutingTable(Nothing) returns (RTCopyResponse);
    rpc AddBackpointer(BackpointerRequest) returns (Nothing);
    rpc RemoveBackpointer(Neighbor) returns (Nothing);
    rpc NotifyMulticast(MulticastRequest) returns (Nothing);

    // DOLR
    rpc Publish(PublishRequest) returns (Nothing);
    rpc Lookup(LookupRequest) returns (LookupResponse);
    
    // Data Retrieval
    rpc Fetch(FetchRequest) returns (FetchResponse);

    //Replication
    rpc Replicate(ReplicateRequest) returns (Ack);
}