<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tapestry Frontend</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
        background-color: #f0f2f5;
      }
      .sidebar {
        width: 350px;
        padding: 20px;
        border-right: 1px solid #ccc;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }
      .ring-container {
        flex-grow: 1;
        position: relative;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fafafa;
        overflow: hidden;
      }
      .log-container {
        height: 200px;
        border: 1px solid #ddd;
        overflow-y: scroll;
        padding: 10px;
        margin-top: 20px;
        background-color: #222;
        color: #0f0;
        font-family: monospace;
        font-size: 12px;
        border-radius: 8px;
      }
      .node {
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: #1f77b4;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .node:hover {
        transform: scale(1.1);
        z-index: 20;
        background-color: #0056b3;
      }
      .details-panel {
        display: none;
        margin-top: 20px;
      }
      h2,
      h3,
      h4,
      h5 {
        color: #333;
      }

      .action-group {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
      }
      .action-group h5 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 14px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      button {
        padding: 8px 12px;
        border: none;
        background-color: #28a745;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        margin-top: 5px;
      }
      button.spawn-btn {
        margin-bottom: 10px;
        background-color: #1f77b4;
      }
      button:hover {
        opacity: 0.9;
      }

      input {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 8px;
        width: calc(100% - 18px);
        font-size: 13px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 4px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      .rt-cell {
        font-family: monospace;
        cursor: help;
      }
      ul {
        padding-left: 20px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>Tapestry Controls</h2>
      <button class="spawn-btn" onclick="addNode()">Spawn New Node</button>
      <hr />

      <div id="details-panel" class="details-panel">
        <h3 id="details-title">Node Details</h3>
        <p style="font-size: 12px">
          <strong>ID:</strong>
          <span
            id="node-id-full"
            style="font-family: monospace; word-break: break-all"
          ></span>
        </p>
        <p style="font-size: 12px">
          <strong>Port:</strong> <span id="node-port"></span>
        </p>

        <h4>Actions</h4>

        <div class="action-group">
          <h5>Store & Publish Object</h5>
          <input id="publish-key" placeholder="Key (e.g. 'my-photo')" />
          <input id="publish-value" placeholder="Value (e.g. 'base64 data')" />
          <button onclick="publish()">Publish</button>
        </div>

        <div class="action-group">
          <h5>Find & Fetch Object</h5>
          <input id="find-key" placeholder="Key to find" />
          <button onclick="find()" style="background-color: #17a2b8">
            Find
          </button>
        </div>

        <div
          class="action-group"
          style="border-color: #ffcccc; background: #fff5f5"
        >
          <h5 style="color: #d9534f">Danger Zone</h5>
          <button onclick="leaveNetwork()" style="background-color: #dc3545">
            Leave Network (Graceful)
          </button>
        </div>

        <div id="details-content"></div>
      </div>
    </div>

    <div class="main-content">
      <div class="ring-container" id="ring-container"></div>
      <div class="log-container" id="log-container"></div>
    </div>

    <script>
      let selectedNode = null;
      const logContainer = document.getElementById("log-container");

      window.onload = () => {
        fetchNodes();
        connectWebSocket();
        setInterval(fetchNodes, 5000);
      };

      async function fetchNodes() {
        try {
          const response = await fetch("/nodes");
          const nodes = await response.json();
          renderRing(nodes);
        } catch (e) {
          console.error("Failed to fetch nodes", e);
        }
      }

      function renderRing(nodes) {
        const ring = document.getElementById("ring-container");
        ring.innerHTML = "";

        const radius = Math.min(ring.clientWidth, ring.clientHeight) / 2 - 50;
        const centerX = ring.clientWidth / 2;
        const centerY = ring.clientHeight / 2;

        nodes.sort((a, b) => a.port - b.port);

        nodes.forEach((node, i) => {
          const angle = (i / nodes.length) * 2 * Math.PI;
          const x = centerX + radius * Math.cos(angle) - 25;
          const y = centerY + radius * Math.sin(angle) - 25;

          const nodeEl = document.createElement("div");
          nodeEl.className = "node";
          nodeEl.style.left = `${x}px`;
          nodeEl.style.top = `${y}px`;
          nodeEl.innerText = node.port;
          nodeEl.title = `Port: ${node.port}`;

          nodeEl.onclick = () => showNodeDetails(node);
          ring.appendChild(nodeEl);
        });
      }

      async function addNode() {
        await fetch("/add-node", { method: "POST" });
        setTimeout(fetchNodes, 500);
      }

      async function showNodeDetails(node) {
        selectedNode = node;
        try {
          const response = await fetch(
            `http://localhost:${node.httpPort}/status`
          );
          if (!response.ok) throw new Error("Node unreachable");
          const status = await response.json();

          document.getElementById(
            "details-title"
          ).innerText = `Node ${status.port}`;
          document.getElementById("node-id-full").innerText = status.id;
          document.getElementById("node-port").innerText = status.port;

          let contentHtml = "";

          contentHtml += "<h4>Stored Objects (Local)</h4>";
          if (status.objects && status.objects.length > 0) {
            contentHtml += "<table><tr><th>Key</th><th>Data</th></tr>";
            status.objects.forEach((o) => {
              let displayData =
                o.Data.length > 20 ? o.Data.substring(0, 20) + "..." : o.Data;
              contentHtml += `<tr><td>${o.Key}</td><td>${displayData}</td></tr>`;
            });
            contentHtml += "</table>";
          } else {
            contentHtml += "<p><i>Empty</i></p>";
          }

          contentHtml += "<h4>Backpointers</h4>";
          if (status.backpointers && status.backpointers.length > 0) {
            contentHtml += "<ul>";
            status.backpointers.forEach((bp) => {
              contentHtml += `<li style="font-size:10px; font-family:monospace">${bp}</li>`;
            });
            contentHtml += "</ul>";
          } else {
            contentHtml += "<p><i>None</i></p>";
          }

          contentHtml += "<h4>Routing Table</h4>";
          if (status.routingTable && status.routingTable.length > 0) {
            contentHtml += "<table><tr><th>Lvl</th>";
            for (let k = 0; k < 16; k++)
              contentHtml += `<th>${k.toString(16).toUpperCase()}</th>`;
            contentHtml += "</tr>";

            for (let i = 0; i < status.routingTable.length; i++) {
              contentHtml += `<tr><td><strong>${i}</strong></td>`;
              status.routingTable[i].forEach((cell) => {
                const val = cell === "." ? "." : "â–ˆ";
                const title = cell === "." ? "Empty" : cell;
                contentHtml += `<td class="rt-cell" title="${title}">${val}</td>`;
              });
              contentHtml += "</tr>";
            }
            contentHtml += "</table>";
          }

          document.getElementById("details-content").innerHTML = contentHtml;
          document.getElementById("details-panel").style.display = "block";
        } catch (e) {
          alert("Could not fetch node details. Is it running?");
        }
      }

      async function publish() {
        if (!selectedNode) return;
        const key = document.getElementById("publish-key").value;
        const value = document.getElementById("publish-value").value;
        if (!key || !value) return alert("Please enter both Key and Value");

        try {
          await fetch(`http://localhost:${selectedNode.httpPort}/publish`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ key, value }),
          });
          log(`Published object '${key}' on Node ${selectedNode.port}`);
          showNodeDetails(selectedNode);
        } catch (e) {
          alert(e);
        }
      }

      async function find() {
        if (!selectedNode) return;
        const key = document.getElementById("find-key").value;
        if (!key) return alert("Please enter a Key to find");

        try {
          const response = await fetch(
            `http://localhost:${selectedNode.httpPort}/find`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ key }),
            }
          );
          if (response.ok) {
            const obj = await response.json();
            alert(`FOUND!\nKey: ${obj.Key}\nData: ${obj.Data}`);
            log(`Success: Found '${key}' -> ${obj.Data}`);
          } else {
            alert("Object not found in network.");
            log(`Failed: Could not locate '${key}'`);
          }
        } catch (e) {
          alert(e);
        }
      }

      function connectWebSocket() {
        const ws = new WebSocket("ws://localhost:3000/logs");
        ws.onmessage = (event) => log(event.data);
        ws.onclose = () => setTimeout(connectWebSocket, 1000);
      }

      function log(msg) {
        const div = document.createElement("div");
        div.innerText = `> ${msg}`;
        logContainer.appendChild(div);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function leaveNetwork() {
        if (!selectedNode) return;
        if (!confirm("Are you sure you want to shut down this node?")) return;

        try {
          await fetch(`http://localhost:${selectedNode.httpPort}/leave`, {
            method: "POST",
          });
          alert("Node is shutting down.");
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
